javascript:(function(){/*==Hermes AutoMoodle v1.5.6==by:thx*/const d=document;function c(t){const e=d.createElement("div");e.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;color:white;font-family:Arial,sans-serif";e.innerHTML=`<div style="font-size:24px;font-weight:bold;color:#4CAF50;margin-bottom:20px">Hermes v1.5.6 | by: thx</div><div style="border:16px solid #f3f3f3;border-radius:50%;border-top:16px solid #4CAF50;width:120px;height:120px;animation:spin 2s linear infinite;margin-bottom:20px"></div><div id="hermes-status" style="font-size:24px;font-weight:bold">Iniciando...</div><div id="hermes-progress" style="margin-top:10px"></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>`;d.body.appendChild(e);return{overlay:e,status:d.getElementById("hermes-status"),progress:d.getElementById("hermes-progress")}}class IA_Integration{static async getAnswer(e,t){const n="AIzaSyDaMHPhn8G_LtUc3w9NVi3pBRlnfSYr3g0",o=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${n}`;try{if(!e||!t||0===t.length)return console.warn("Par√¢metros inv√°lidos para IA:",{question:e,options:t}),t[0]||"Resposta padr√£o";const r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`Voc√™ √© um professor especialista. Responda APENAS com o n√∫mero da op√ß√£o correta (1-${t.length}) para:\n\nPERGUNTA: "${e}"\n\nOP√á√ïES:\n${t.map((e,o)=>`${o+1}. ${e}`).join("\n")}`}]}],generationConfig:{temperature:.1,maxOutputTokens:5}})});if(!r.ok)throw new Error(`Erro HTTP: ${r.status}`);const a=await r.json();if(!a.candidates||!a.candidates[0].content.parts[0].text)throw new Error("Resposta da API em formato inesperado");const s=a.candidates[0].content.parts[0].text.trim(),l=parseInt(s);return isNaN(l)?(console.warn("IA retornou valor n√£o num√©rico:",s),t[0]):l<1||l>t.length?(console.warn("N√∫mero fora do intervalo:",l),t[0]):t[l-1]}catch(e){return console.error("Erro na IA:",e),t[0]||"Resposta padr√£o"}}}class RequestManager{constructor(e="https://expansao.educacao.sp.gov.br",t=3){this.baseUrl=e.startsWith("https://")?e:e.replace(/^http:/,"https:"),this.maxRetries=t}async fetchWithRetry(e,t={},n=this.maxRetries){if(!e)throw new Error("URL n√£o pode ser vazia");try{const n=await fetch(e,{credentials:"include",...t});if(!n.ok)throw new Error(`HTTP ${n.status}`);return n}catch(r){if(n>0){const o=2e3*(this.maxRetries-n+1);return console.warn(`Tentativa ${this.maxRetries-n+1}/${this.maxRetries}. Aguardando ${o}ms...`),await new Promise(e=>setTimeout(e,o)),this.fetchWithRetry(e,t,n-1)}throw r}}createUrl(e,t={}){try{const n=new URL(e,this.baseUrl);return Object.entries(t).forEach(([e,t])=>{void 0!==t&&null!==t&&n.searchParams.append(e,t)}),n.toString()}catch(r){throw console.error("Erro ao criar URL:",{path:e,params:t}),new Error("URL inv√°lida")}}}class ExamAutomator{constructor(){this.requestManager=new RequestManager,console.log("ExamAutomator inicializado")}async completeExam(e){console.log("Iniciando completeExam para:",e);try{const{contextId:t,sessKey:n}=await this.fetchExamPage(e),{redirectUrl:o,attemptId:r}=await this.startExamAttempt(t,n),a=await this.extractQuestionInfo(o),{attemptId:s,sesskey:l}=await this.submitAnswer(a,t),c=await this.finishExamAttempt(s,t,l);return console.log("Question√°rio finalizado:",c),c}catch(t){throw console.error("Erro em completeExam:",t),t}}async fetchExamPage(e){console.log("Buscando p√°gina do exame:",e);try{const t=await this.requestManager.fetchWithRetry(e),n=await t.text(),o=new URL(e),r=o.searchParams.get("id")||(n.match(/contextInstanceId":(\d+)/)||[])[1]||(n.match(/cmid=(\d+)/)||[])[1],a=(n.match(/sesskey":"([^"]+)/)||[])[1]||(n.match(/sesskey=([^"&]+)/)||[])[1];if(!r)throw new Error("CMID n√£o encontrado na p√°gina");if(!a)throw new Error("Sesskey n√£o encontrado na p√°gina");return console.log("Dados extra√≠dos:",{contextId:r,sessKey:a}),{contextId:r,sessKey:a}}catch(t){throw console.error("Erro em fetchExamPage:",t),t}}async startExamAttempt(e,t){console.log("Iniciando tentativa:",{contextId:e,sessKey:t});try{const n=await this.requestManager.fetchWithRetry(this.requestManager.createUrl("/mod/quiz/startattempt.php"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({cmid:e,sesskey:t})}),o=(n.url.match(/attempt=(\d+)/)||[])[1];if(!o)throw new Error("N√£o foi poss√≠vel obter o ID da tentativa");return console.log("Tentativa iniciada com sucesso:",{attemptId:o}),{redirectUrl:n.url,attemptId:o}}catch(n){throw console.error("Erro em startExamAttempt:",n),n}}async extractQuestionInfo(e){console.log("Extraindo informa√ß√µes da quest√£o:",e);try{const t=await this.requestManager.fetchWithRetry(e),n=new DOMParser().parseFromString(await t.text(),"text/html"),o={questId:null,seqCheck:null,options:[],attempt:null,sesskey:null,formFields:{},questionText:n.querySelector(".qtext")?.textContent.trim()||"Quest√£o sem texto"};return n.querySelectorAll("input[type='hidden']").forEach(e=>{const t=e.getAttribute("name"),n=e.getAttribute("value");if(!t||null===n)return;t.includes(":sequencecheck")?(o.questId=t.split(":")[0],o.seqCheck=n):"attempt"===t?o.attempt=n:"sesskey"===t?o.sesskey=n:["thispage","nextpage","timeup","mdlscrollto","slots"].includes(t)&&(o.formFields[t]=n)}),n.querySelectorAll("input[type='radio'], input[type='checkbox']").forEach(e=>{e.name?.includes("_answer")&&"-1"!==e.value&&o.options.push({name:e.name,value:e.value,text:e.nextElementSibling?.textContent.trim()||e.closest(".answer")?.textContent.trim()||`Op√ß√£o ${e.value}`})}),o.questId||(console.warn("questId n√£o encontrado, tentando fallback"),o.questId=Object.keys(o.formFields).find(e=>e.includes(":sequencecheck"))?.split(":")[0]),!o.questId||!o.attempt||!o.sesskey?void console.error("Dados da quest√£o incompletos:",o):console.log("Dados da quest√£o extra√≠dos:",o),o}catch(t){throw console.error("Erro em extractQuestionInfo:",t),t}}async submitAnswer(e,t){console.log("Submetendo resposta:",{questionData:e,contextId:t});try{e.options.length<1&&(console.warn("Nenhuma op√ß√£o encontrada, adicionando fallback"),e.options.push({name:`${e.questId}_answer`,value:"1",text:"Resposta padr√£o"}));let n;try{n=await IA_Integration.getAnswer(e.questionText,e.options.map(e=>e.text)),e.options.some(e=>e.text===n)||(console.warn("Resposta da IA n√£o corresponde a nenhuma op√ß√£o:",n),n=e.options[0].text)}catch(o){console.error("Erro ao obter resposta da IA, usando fallback:",o),n=e.options[0].text}const o=e.options.find(e=>e.text===n)||e.options[0],r=new FormData;r.append(`${e.questId}:1_:flagged`,"0"),r.append(`${e.questId}:1_:sequencecheck`,e.seqCheck),r.append(o.name,o.value),r.append("next","Finalizar tentativa ..."),r.append("attempt",e.attempt),r.append("sesskey",e.sesskey),r.append("slots","1"),Object.entries(e.formFields).forEach(([e,t])=>{void 0!==t&&null!==t&&r.append(e,t)});const a=await this.requestManager.fetchWithRetry(this.requestManager.createUrl(`/mod/quiz/processattempt.php?cmid=${t}`),{method:"POST",body:r});return console.log("Resposta submetida com sucesso"),{redirectUrl:a.url,attemptId:e.attempt,sesskey:e.sesskey}}catch(n){throw console.error("Erro em submitAnswer:",n),n}}async finishExamAttempt(e,t,n){console.log("Finalizando tentativa:",{attemptId:e,contextId:t,sesskey:n});try{await this.requestManager.fetchWithRetry(this.requestManager.createUrl("/mod/quiz/summary.php",{attempt:e,cmid:t}));const o=await this.requestManager.fetchWithRetry(this.requestManager.createUrl("/mod/quiz/processattempt.php"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({attempt:e,finishattempt:"1",timeup:"0",slots:"",cmid:t,sesskey:n})});return console.log("Tentativa finalizada com sucesso"),o.url}catch(o){throw console.error("Erro em finishExamAttempt:",o),o}}}class ActivityProcessorUI{constructor(){this.examAutomator=new ExamAutomator,this.createUI(),console.log("ActivityProcessorUI inicializado")}createUI(){console.log("Criando interface do usu√°rio...");const e=d.getElementById("hermes-overlay");e&&e.remove();const t=d.createElement("div");t.id="hermes-overlay",t.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;color:white;font-family:Arial,sans-serif",t.innerHTML='<div style="font-size:24px;font-weight:bold;color:#4CAF50;margin-bottom:20px">Hermes v1.5.6 | by: thx</div><div style="border:16px solid #f3f3f3;border-radius:50%;border-top:16px solid #4CAF50;width:120px;height:120px;animation:spin 2s linear infinite;margin-bottom:20px"></div><div id="hermes-status" style="font-size:24px;font-weight:bold;text-align:center;max-width:80%">Iniciando...</div><div id="hermes-progress" style="margin-top:20px;color:#aaa"></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>',d.body.appendChild(t),this.statusElement=d.getElementById("hermes-status"),this.progressElement=d.getElementById("hermes-progress"),console.log("Interface criada com sucesso")}async processActivities(){console.log("Iniciando processamento de atividades..."),this.updateStatus("üîç Detectando atividades...");try{const e=Array.from(d.querySelectorAll("li.activity")).filter(e=>{try{const t=e.querySelector("a.aalink, .activityinstance a"),n=e.querySelector(".completion-dropdown button.btn-success");return t?.href&&!n}catch(t){return console.warn("Erro ao processar atividade:",t),!1}}).map(e=>{try{const t=e.querySelector("a.aalink, .activityinstance a"),n=new URL(t.href,window.location.href);return{id:n.searchParams.get("id"),href:n.href,name:t.textContent.trim(),type:/responda|pause|question√°rio|quiz/i.test(t.textContent)?"exam":"page"}}catch(t){return console.warn("Erro ao mapear atividade:",t),null}}).filter(e=>null!==e);console.log("Atividades detectadas:",e);const t=e.filter(e=>"exam"===e.type),n=e.filter(e=>"page"===e.type);if(n.length>0&&(this.updateStatus(`üìö Marcando ${n.length} p√°ginas como conclu√≠das...`),await Promise.all(n.map(async(e,t)=>{try{await fetch(`${this.examAutomator.requestManager.baseUrl}/mod/resource/view.php?id=${e.id}`,{credentials:"include"}),this.updateStatus(`üìö P√°gina ${t+1}/${n.length} conclu√≠da`)}catch(o){console.warn(`Erro ao marcar p√°gina ${e.id} como conclu√≠da:`,o)}}))),t.length>0)for(let e=0;e<t.length;e++){const n=t[e];this.updateStatus(`üìù Processando: ${n.name} (${e+1}/${t.length})`);try{await this.examAutomator.completeExam(n.href),this.updateStatus(`‚úÖ ${n.name} conclu√≠do (${e+1}/${t.length})`)}catch(o){console.error(`Erro ao processar ${n.name}:`,o),this.updateStatus(`‚ö†Ô∏è Erro em ${n.name}, tentando novamente... (${e+1}/${t.length})`),await new Promise(t=>setTimeout(t,5e3)),e--;continue}e<t.length-1&&await new Promise(e=>setTimeout(e,2e3))}this.updateStatus("‚úÖ Todas atividades conclu√≠das! Recarregando..."),setTimeout(()=>location.reload(),2e3)}catch(e){console.error("Erro fatal em processActivities:",e),this.updateStatus(`‚ùå Erro cr√≠tico: ${e.message}`),setTimeout(()=>location.reload(),5e3)}}updateStatus(e){this.statusElement&&(this.statusElement.textContent=e,console.log("Status:",e))}}console.log("Inicializando Hermes v1.5.6..."),"expansao.educacao.sp.gov.br"===window.location.hostname?("complete"===document.readyState||"interactive"===document.readyState?new ActivityProcessorUI().processActivities():d.addEventListener("DOMContentLoaded",()=>{new ActivityProcessorUI().processActivities()})):alert("Hermes s√≥ funciona no Moodle da Expans√£o SP"),console.error("Dom√≠nio n√£o suportado:",window.location.hostname);})();
